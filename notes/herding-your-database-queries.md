## Herding your database queries
### by Ilya Bass
---
## Hearding your Database Queries by Ilya Bass
- ORM is awesome
- Book object, Author FK relation
  - `book.author` can execute a db query, unless you did something like select_relateed
  - db will cache the result, so no big deal!
  - lots of code spawns lots of queries without realizing
- sometimes problem is more subtle
  - serializers wrapping models, but can have a db query for serializer field, 2 queries per serializer
  - property that runs db query every time
  - overhead of processing, need more backends
- options for tracking queries
  - django debug toolbar
  - django-silk
  - DB logging
  - custom middleware
- Open source ingredients
  - django middleware
  - `django.db.connections`, way to iterate thru db connections
  - `execute_wrapper` 
  - `contextlib.ExitStack`
  - core concept
    - middleware in __call__
    - querystats wrapper
    - enter context, accumulate in exit stack
  - querystats
    - sql statement
    - call stack
    - time
- what to do with output?
  - number of queries?
  - same query executes is clear candidate for optimization
  - call stacks indispensible in finding hot spots
- fixing issues
  - `select_related` - related objects via join
  - `prefetch_related` - does separate query for each relationship
    - *_related will do full lookup for related object, that can have its own overhead
    - pagination is your friend to reduce db queries 
  - serializers - retrieve data and pass it via context
  - `@cached_property` - persist property in an instance
- guarding against future issues
  - unittests
    - `django_assert_max_num_queries` fixture to verify a scope doesn't exceed the limit
    - new endpoint
      - coverage context to mark unit tests that guard query counts
      - see what endpoints or other scopes are not covered in above contexts
  - run-time monitoring
    - middleware logs
    - kibana, smiliar monitors for excessive queries
- github.com/Path-AI/django-request-stats-example